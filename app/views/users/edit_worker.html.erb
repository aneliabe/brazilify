<% latest_sub = current_user.latest_subscription %>

<%= simple_form_for @worker_profile, url: update_worker_user_path(@user), method: :patch, html: { multipart: true }, data: { controller: "worker-form", worker_form_max_photos_value: 9 } do |f| %>

  <% if @worker_profile.errors.any? %>
    <div class="alert alert-danger" role="alert">
      <h6 class="alert-heading">Erro ao salvar:</h6>
      <ul class="mb-0">
        <% @worker_profile.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <br>
  <%= f.input :cpf, label: "CPF", input_html: { class: "form-control" } %>
  <%= f.input :description, as: :text, label: "Descrição", input_html: { class: "form-control", rows: 3 } %>

  <!-- Container where service rows will be added -->
  <div id="worker-services" data-worker-form-target="servicesContainer">
    <% if @worker_profile.worker_services.any? %>
      <%= f.simple_fields_for :worker_services do |ws| %>
        <%= render "worker_service_fields", f: ws, categories: @categories, service_types: @service_types %>
      <% end %>
    <% else %>
      <%= f.simple_fields_for :worker_services, @worker_profile.worker_services.build do |ws| %>
        <%= render "worker_service_fields", f: ws, categories: @categories, service_types: @service_types %>
      <% end %>
    <% end %>
  </div>

  <!-- Hidden template for new service rows -->
  <template id="worker-service-template">
    <%= f.simple_fields_for :worker_services, WorkerService.new, child_index: "NEW_RECORD" do |ws| %>
      <%= render "worker_service_fields", f: ws, categories: @categories, service_types: @service_types %>
    <% end %>
  </template>

  <!-- <div class="mt-2">
    <%= link_to "Adicionar serviço", "#", class: "btn btn-outline-secondary", data: { action: "click->worker-form#addServiceRow" } %>
  </div> -->
  <% if latest_sub&.status == "active" %>
    <div class="mt-2">
      <%= link_to "Adicionar serviço", "#", class: "btn btn-outline-secondary", data: { action: "click->worker-form#addServiceRow" } %>
    </div>
  <% end %>

  <div class="mb-3 mt-3">
    <%= f.label :services_photos, "Adicione até 9 fotos dos seus trabalhos realizados", class: "form-label" %>
    <%= f.file_field :services_photos,
          multiple: true,
          accept: "image/*",
          direct_upload: true,
          class: "form-control",
          data: {
            action: "change->worker-form#enforcePhotoLimit"
          } %>
  </div>

  <div class="mt-3 mb-3">
    <%= f.submit @user.worker? ? "Atualizar informações" : "Ativar perfil de prestador", class: "btn btn-primary" %>
  </div>

<% end %>
