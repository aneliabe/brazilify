<% latest_sub = current_user.latest_subscription %>
<div class="container dashboard" style="max-width:1100px;margin:2rem auto;">

  <!-- Header: avatar + name + quick actions -->
  <div class="glass-card p-3 p-md-4 mb-3">
    <div class="d-flex align-items-center gap-3 flex-wrap">
                <%= if current_user.photo.attached?
                cl_image_tag current_user.photo.key,
                  width: 56, height: 56, dpr: 2, crop: :fill, gravity: :face,
                  quality: "auto", fetch_format: "auto",
                  # class: "dropdown-toggle rounded-circle ms-md-auto", id: "navbarDropdown",
                  # role: "button", data: { bs_toggle: "dropdown" },
                  aria: { haspopup: "true", expanded: "false" }, style: "object-fit:cover;"
              else
                image_tag "default-avatar.png",
                  width: 56, height: 56,
                  # class: "dropdown-toggle rounded-circle ms-md-auto", id: "navbarDropdown",
                  # role: "button", data: { bs_toggle: "dropdown" },
                  aria: { haspopup: "true", expanded: "false" }, style: "object-fit:cover;"
              end %>

      <div class="flex-grow-1 min-w-0">
        <h1 class="h4 m-0 text-truncate">Meu Dashboard</h1>
        <div class="text-muted small mt-1">
          <i class="fa-solid fa-user"></i> <%= @user.full_name %>
          <% if [@user.city, @user.country].compact.any? %>
            ‚Ä¢ <i class="fa-solid fa-location-dot"></i> <%= [@user.city, @user.country].compact.join(", ") %>
          <% end %>
          <% if (wp = @user.try(:worker_profile)) %>
            ‚Ä¢ <i class="fa-solid fa-star text-warning"></i>
            <%= wp.average_rating %> (<%= wp.reviews.count %> avalia√ß√µes)
          <% end %>
        </div>
      </div>

      <div class="d-flex gap-2 ms-auto">
        <%= link_to "Meus agendamentos", my_appointments_path, class: "btn btn-primary" %>
        <%= link_to "Ver meu perfil", worker_path(@user.worker_profile), class: "btn btn-primary" %>

        <div class="dropdown">
          <button class="btn btn-primary" type="button" data-bs-toggle="dropdown">
            Editar perfil
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li><%= link_to "Perfil pessoal", edit_profile_user_path(@user), class: "dropdown-item" %></li>
            <li><%= link_to "Perfil profissional", edit_worker_user_path(@user), class: "dropdown-item" %></li>
          </ul>
        </div>
      </div>

  <div class="row g-3">
    <!-- Servi√ßos oferecidos -->
    <div class="col-12 col-lg-6">
      <div class="glass-card p-3 p-md-4 h-100">
        <h2 class="h6 fw-bold mb-2">Servi√ßos oferecidos</h2>

        <% if @user.role == "worker" && @worker_services.present? %>
          <div class="chips">
            <% @worker_services.each do |ws| %>
              <span class="chip d-inline-flex align-items-center gap-1">
                <i class="fa-solid fa-briefcase"></i>
                <span class="text-truncate">
                  <%= ws.category.name %> ‚Ä¢ <strong><%= ws.service.name %></strong>
                </span>
                <span class="badge badge-soft ms-1"><%= ws.service_type.humanize %></span>
              </span>
            <% end %>
          </div>
        <% else %>
          <p class="text-muted m-0">Nenhum servi√ßo cadastrado.</p>
        <% end %>
      </div>
    </div>

      <!-- Descri√ß√£o -->
  <div class="col-12 col-lg-6">
    <div class="glass-card p-3 p-md-4 h-100">
      <h2 class="h6 fw-bold mb-2">Descri√ß√£o dos servi√ßos</h2>

      <dl>
        <div>
          <dd><%= @worker_profile.description.presence || "‚Äî" %></dd>
        </div>
      </dl>
    </div>
  </div>

    <!-- Dados do prestador -->
  <div class="col-12 col-lg-6">
    <div class="glass-card p-3 p-md-4 h-100">
      <h2 class="h6 fw-bold mb-2">Informa√ß√µes do prestador</h2>

      <dl class="info-grid">
        <div><dt>Nome completo</dt><dd><%= @user.full_name %></dd></div>
        <div><dt>Data de nascimento</dt><dd><%= @user.birth_date.presence || "‚Äî" %></dd></div>
        <div><dt>CPF</dt><dd><%= @worker_profile.cpf.presence || "‚Äî" %></dd></div>
        <div><dt>Endere√ßo</dt><dd><%= @user.address.presence || "‚Äî" %></dd></div>
        <div><dt>Cidade</dt><dd><%= @user.city.presence || "‚Äî" %></dd></div>
        <div><dt>Pa√≠s</dt><dd><%= @user.country.presence || "‚Äî" %></dd></div>
        <div><dt>C√≥digo do pa√≠s</dt><dd><%= @user.country_code.presence || "‚Äî" %></dd></div>
        <div><dt>Telefone</dt><dd><%= @user.phone.presence || "‚Äî" %></dd></div>
        <div><dt>Email</dt><dd><%= @user.email %></dd></div>
      </dl>
    </div>
  </div>

<div class="col-12 col-lg-6">
  <div class="glass-card p-3 p-md-4 h-100">
    <% if latest_sub.nil? || latest_sub.status == "canceled" %>
      <h2 class="h6 fw-bold mb-3">Vantagens do Plano Premium</h2>

      <div class="mb-3">
        <ul class="list-unstyled">
          <li class="d-flex align-items-center mb-2">
            <i class="fa-solid fa-check-circle text-success me-2"></i>
            Adicionar mais servi√ßos
          </li>
          <li class="d-flex align-items-center mb-2">
            <i class="fa-solid fa-check-circle text-success me-2"></i>
            Maior visibilidade no sistema
          </li>
          <li class="d-flex align-items-center mb-2">
            <i class="fa-solid fa-check-circle text-success me-2"></i>
            Suporte priorit√°rio
          </li>
          <li class="d-flex align-items-center mb-2">
            <i class="fa-solid fa-check-circle text-success me-2"></i>
            Custa menos do que duas pints por m√™s
          </li>
        </ul>
      </div>

      <%= form_with url: subscriptions_path, method: :post, data: { turbo: false }, local: true do %>
        <%= submit_tag "üíé Fazer Upgrade",
            class: "btn-premium mt-4",
            style: "border: none; color: white; font-weight: 600; width: 100%;" %>
      <% end %>

    <% elsif latest_sub&.status == "active" %>
      <h2 class="h6 fw-bold mb-3 text-success">Plano Premium Ativo</h2>

      <div class="alert alert-success mb-3" role="alert">
        <i class="fa-solid fa-crown me-2"></i>
        Voc√™ possui acesso a todos os recursos premium!
      </div>

      <%= button_to "Cancelar assinatura",
            cancel_subscription_path(latest_sub),
            method: :patch,
            data: { confirm: "Tem certeza que deseja cancelar?" },
            class: "btn btn-outline-danger rounded-pill px-4",
            style: "width: 100%;" %>
    <% end %>
  </div>
</div>

  <%= render "worker_dashboard_photos", worker_profile: @worker_profile %>
</div>

 <!-- <%= form_with url: subscriptions_path, method: :post, data: { turbo: false } do %>
    <%= submit_tag "Upgrade", class: "btn btn-primary" %>
  <% end %> -->
</div>
