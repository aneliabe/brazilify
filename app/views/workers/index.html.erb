<div class="workers-page">
  <div class="container" style="max-width:1100px;margin:2rem auto;">

    <div class="d-flex align-items-end justify-content-between mb-3">
      <h1 class="h4 m-0">Prestadores</h1>
    </div>

    <!-- Filters -->
    <div class="glass-card p-3 p-md-4 mb-3">
      <%= form_with url: workers_path, method: :get, local: true,
                    html: { class: "filter-form row g-2 align-items-end" } do %>

        <div class="col-12 col-md-5">
          <label class="form-label">Cidade</label>
          <%= text_field_tag :city, @city, class: "form-control",
                placeholder: "Cidade (ex.: São Paulo)" %>
        </div>

        <div class="col-12 col-md-5">
          <label class="form-label">Serviço</label>
          <select name="service_id" class="form-select">
            <option value="">Todos os serviços</option>
            <% @services.each do |s| %>
              <option value="<%= s.id %>" <%= "selected" if s.id.to_s == @svc %>>
                <%= s.name %>
              </option>
            <% end %>
          </select>
        </div>

        <div class="col-12 col-md-2 d-grid">
          <button class="btn btn-primary" type="submit">
            <i class="fa-solid fa-magnifying-glass"></i> Filtrar
          </button>
        </div>

        <% if @filters_applied %>
          <div class="col-12">
            <%= link_to "Limpar filtros", workers_path, class: "btn btn-outline-secondary btn-sm" %>
          </div>
        <% end %>
      <% end %>
    </div>

    <% if @workers.blank? %>
      <div class="glass-card p-4 text-center text-muted">
        Nenhum profissional encontrado.
      </div>
    <% else %>
      <div class="row g-3">
        <% @workers.each do |w| %>
          <div class="col-12 col-md-6">
            <div class="glass-card worker-card p-3 h-100">
              <!-- header -->
              <div class="d-flex gap-3 align-items-center">
                <img src="<%= w.user.avatar.presence || 'https://placehold.co/64x64' %>"
                     alt="" class="avatar-lg">
                <div class="flex-grow-1 min-w-0">
                  <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
                    <h3 class="h6 m-0 text-truncate"><%= w.user.full_name %></h3>

                    <!-- stars + count -->
                    <div class="d-inline-flex align-items-center gap-2">
                      <span class="text-warning">
                        <% avg = w.average_rating.to_f %>
                        <% 5.times do |i| %>
                          <i class="fa-<%= i < avg.round ? 'solid' : 'regular' %> fa-star"></i>
                        <% end %>
                      </span>
                      <small class="text-muted"><%= number_with_precision(avg, precision: 1) %> · <%= w.reviews.count %></small>
                    </div>
                  </div>

                  <div class="text-muted small">
                    <i class="fa-solid fa-location-dot"></i>
                    <%= [w.user.city, w.user.country].compact.join(", ") %>
                  </div>
                </div>
              </div>

              <!-- description -->
              <p class="mt-2 mb-2 text-muted"><%= w.description.to_s.truncate(120) %></p>

              <!-- services -->
              <% if w.services.any? %>
                <div class="chips mb-2">
                  <% w.services.limit(5).each do |svc| %>
                    <span class="chip"><i class="fa-solid fa-tag"></i> <%= svc.name %></span>
                  <% end %>
                </div>
              <% end %>

              <!-- actions -->
              <div class="d-flex justify-content-end gap-2">
                <%= link_to "Ver perfil", worker_path(w), class: "btn-line btn-chat" %>
              </div>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>
