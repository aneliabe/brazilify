<div class="worker-page">
  <div class="container" style="max-width: 1040px; margin: 2rem auto;">

    <div class="glass-card p-3 p-md-4 mb-3">
      <div class="row g-4 align-items-center">
        <div class="col-auto">
          <div class="profile-avatar">
            <%= render "shared/avatar", user: @worker.user, size: 96 %>
          </div>
        </div>

        <div class="col">
          <div class="d-flex flex-wrap align-items-center gap-2">
            <h1 class="h4 m-0"><%= @worker.user.full_name %></h1>
            <span class="text-muted small">
              <i class="fa-solid fa-location-dot"></i>
              <%= [@worker.user.city, @worker.user.country].compact.join(", ") %>
            </span>
          </div>

          <div class="d-flex flex-wrap align-items-center gap-2 mt-2">
            <!-- stars -->
            <span class="text-warning">
              <% avg = @worker.average_rating.to_f %>
              <% 5.times do |i| %>
                <i class="fa-<%= i < avg.round ? 'solid' : 'regular' %> fa-star"></i>
              <% end %>
            </span>
            <span class="text-muted small">
              <%= number_with_precision(avg, precision: 1) %> de 5
              • <%= @worker.reviews.count %> avaliações
            </span>
          </div>

          <% if @worker.description.present? %>
            <p class="mt-3 mb-0 text-muted"><%= @worker.description %></p>
          <% end %>
        </div>

        <div class="col-12 col-md-auto ms-md-auto">
          <button type="button"
                  class="btn-line"
                  data-bs-toggle="modal" data-bs-target="#requestTimeModal">
            <i class="fa-regular fa-calendar-plus"></i>
            Solicitar horário
          </button>
        </div>
      </div>

      <!-- Services as chips -->
      <div class="mt-3">
        <% if @worker.services.any? %>
          <div class="chips">
            <% @worker.services.each do |s| %>
              <span class="chip"><i class="fa-solid fa-tag"></i> <%= s.name %></span>
            <% end %>
          </div>
        <% else %>
          <small class="text-muted">Sem serviços cadastrados ainda.</small>
        <% end %>
      </div>
    </div>

    <%= render "shared/worker_service_photos" if @worker.services_photos.attached? %>

    <!-- REVIEWS CARD -->
    <div class="glass-card p-3 p-md-4 mt-3">
      <div class="d-flex align-items-baseline justify-content-between flex-wrap gap-2 mb-3">
        <h2 class="h5 m-0">Avaliações (<%= @worker.reviews.count %>)</h2>
      </div>

      <% if @worker.reviews.exists? %>
        <div class="list-group">
          <% @worker.reviews.includes(:user).order(created_at: :desc).limit(5).each do |rev| %>
            <div class="list-group-item border-0 border-bottom">
              <div class="d-flex align-items-start gap-3">
                <img
                  src="<%= rev.user.avatar.presence || 'https://placehold.co/48x48' %>"
                  class="rounded-circle border" width="40" height="40" alt="" style="object-fit:cover;"
                >
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center justify-content-between">
                    <strong><%= rev.user.full_name.presence || rev.user.email %></strong>
                    <small class="text-muted">
                      <%= l(rev.created_at.to_date, format: :long) rescue rev.created_at.strftime('%d/%m/%Y') %>
                    </small>
                  </div>

                  <div class="text-warning my-1">
                    <% rev.rating.to_i.times { %><i class="fa-solid fa-star"></i><% } %>
                    <% (5 - rev.rating.to_i).times { %><i class="fa-regular fa-star"></i><% } %>
                  </div>

                  <% if rev.comment.present? %>
                    <p class="mb-0"><%= rev.comment %></p>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <% if @worker.reviews.count > 5 %>
          <small class="text-muted d-block mt-2">Mostrando as 5 mais recentes.</small>
        <% end %>
      <% else %>
        <p class="text-muted m-0">Sem avaliações ainda.</p>
      <% end %>
    </div>

  </div>
</div>

<!-- Modal to request time -->
  <div class="modal fade" id="requestTimeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Solicitar horário</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
        </div>

        <div class="modal-body">
          <%# IMPORTANTE: capturar o form builder como |f| %>
          <%= form_with url: worker_appointments_path(@worker), method: :post, html: { class: "appointment-request-form" } do |f| %>
            <div class="mb-3">
              <label class="form-label">Dia e hora</label>
              <input
                type="text"
                name="appointment[starts_at]"
                id="appointment_starts_at"
                class="form-control"
                placeholder="Selecione dia e hora"
                autocomplete="off"
                data-controller="flatpickr"
                data-flatpickr-enable-time-value="true"
                data-flatpickr-time-24hr-value="true"
                data-flatpickr-minute-increment-value="15"
                data-flatpickr-date-format-value="Y-m-d H:i"
                data-flatpickr-min-date-value="today"
              >
              <small class="text-muted">Você poderá combinar a duração no chat.</small>
            </div>

            <div class="mb-3">
              <label class="form-label">Mensagem (opcional)</label>
              <textarea name="message" class="form-control" rows="3" placeholder="Descreva o serviço, endereço/online, urgência…"></textarea>
            </div>

            <div class="d-grid">
              <%# Campo oculto para levar a TZ do navegador do cliente %>
              <%= hidden_field_tag "appointment[time_zone]", "", id: "appt-time-zone" %>
              <button type="submit" class="btn btn-primary">Enviar solicitação</button>
            </div>
          <% end %>

          <script>
            (function setTZOnce(){
              function setTZ() {
                var el = document.getElementById("appt-time-zone");
                if (el) el.value = (Intl.DateTimeFormat().resolvedOptions().timeZone || "");
              }
              document.addEventListener("turbo:load", setTZ);
              document.addEventListener("DOMContentLoaded", setTZ);
            })();
          </script>
        </div>
      </div>
    </div>
  </div>
