<div class="worker-show">
  <div class="card worker-card">
    <div class="worker-header">
      <img src="<%= @worker.user.avatar.presence || 'https://placehold.co/96x96' %>" class="worker-avatar" alt="">
      <div class="worker-headings">
        <h2 class="worker-name"><%= @worker.user.full_name %></h2>
        <small class="worker-sub">
          <i class="fa-solid fa-location-dot"></i>
          <%= [@worker.user.city, @worker.user.country].compact.join(", ") %>
        </small>
        <div class="worker-stats">
          <i class="fa-solid fa-star"></i>
          <span><%= @worker.average_rating %> (<%= @worker.reviews.count %> avaliações)</span>
        </div>
      </div>
    </div>

    <p class="worker-desc"><%= @worker.description %></p>

    <div class="worker-tags">
      <% if @worker.services.any? %>
        <% @worker.services.each do |s| %>
          <span class="tag"><%= s.name %></span>
        <% end %>
      <% else %>
        <small>Sem serviços cadastrados ainda.</small>
      <% end %>
    </div>

    <hr class="divider">

    <div class="worker-cta">
      <h3>Solicitar horário com <%= @worker[:name] %></h3>

      <button type="button" class="see-all-btn" data-bs-toggle="modal" data-bs-target="#requestTimeModal">
        Solicitar horário
      </button>

      <p class="hint">
        Você escolhe a data/hora preferida. O profissional confirma ou sugere outro.
      </p>
    </div>

    <hr class="divider">

    <!-- ✅ NEW: Reviews section -->
    <div class="worker-reviews">
      <h3 class="mb-2">Avaliações (<%= @worker.reviews.count %>)</h3>

      <% if @worker.reviews.exists? %>
        <% avg = @worker.average_rating.to_f %>

        <!-- Average as stars + number -->
        <div class="d-flex align-items-center gap-2 mb-3">
          <div class="text-warning">
            <% 5.times do |i| %>
              <i class="fa-<%= i < avg.round ? 'solid' : 'regular' %> fa-star"></i>
            <% end %>
          </div>
          <small class="text-muted"><%= number_with_precision(avg, precision: 1) %> de 5</small>
        </div>

        <div class="list-group">
          <% @worker.reviews.includes(:user).order(created_at: :desc).limit(5).each do |rev| %>
            <div class="list-group-item">
              <div class="d-flex align-items-start gap-3">
                <img src="<%= rev.user.avatar.presence || 'https://placehold.co/48x48' %>"
                     class="rounded-circle" width="40" height="40" alt="">
                <div class="flex-grow-1">
                  <div class="d-flex align-items-center justify-content-between">
                    <strong><%= rev.user.full_name.presence || rev.user.email %></strong>
                    <small class="text-muted">
                      <%= l(rev.created_at.to_date, format: :long) rescue rev.created_at.strftime('%d/%m/%Y') %>
                    </small>
                  </div>

                  <!-- rating stars -->
                  <div class="text-warning mb-1">
                    <% rev.rating.to_i.times do %><i class="fa-solid fa-star"></i><% end %>
                    <% (5 - rev.rating.to_i).times do %><i class="fa-regular fa-star"></i><% end %>
                  </div>

                  <% if rev.comment.present? %>
                    <p class="mb-0"><%= rev.comment %></p>
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>

        <% if @worker.reviews.count > 5 %>
          <small class="text-muted d-block mt-2">Mostrando as 5 mais recentes.</small>
        <% end %>
      <% else %>
        <p class="text-muted">Sem avaliações ainda.</p>
      <% end %>
    </div>
    <!-- /Reviews -->
  </div>
</div>

<!-- Modal to request time -->
<div class="modal fade" id="requestTimeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Solicitar horário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <%= form_with url: worker_appointments_path(@worker), method: :post, html: { class: "appointment-request-form" } do %>
          <div class="mb-3">
            <label class="form-label">Dia e hora</label>
            <input
              type="text"
              name="appointment[starts_at]"
              id="appointment_starts_at"
              class="form-control"
              placeholder="Selecione dia e hora"
              autocomplete="off"
              data-controller="flatpickr"
              data-flatpickr-enable-time-value="true"
              data-flatpickr-time-24hr-value="true"
              data-flatpickr-minute-increment-value="15"
              data-flatpickr-date-format-value="Y-m-d H:i"
            >
            <small class="text-muted">Você poderá combinar a duração no chat.</small>
          </div>

          <div class="mb-3">
            <label class="form-label">Mensagem (opcional)</label>
            <textarea name="message" class="form-control" rows="3" placeholder="Descreva o serviço, endereço/online, urgência…"></textarea>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Enviar solicitação</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>
