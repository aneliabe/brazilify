<%= turbo_stream_from "appointment_#{@appointment.id}_messages" %>

<div class="container" style="max-width:1040px; margin:2rem auto;">

  <!-- Header (compact & clean) -->
  <div class="d-flex align-items-center justify-content-between flex-wrap gap-3 mb-3">
    <!-- left: back -->
    <div class="flex-shrink-0">
      <%= link_to my_appointments_path,
            class: "btn bg-white border rounded-pill d-flex align-items-center gap-2 px-3 py-2 shadow-sm" do %>
        <i class="fa-solid fa-arrow-left"></i>
        <span>Meus agendamentos</span>
      <% end %>
    </div>

    <!-- center: compact title + time -->
    <div class="flex-grow-1 text-center">
      <div class="fw-semibold text-body" style="font-size:1rem;">
        Seu agendamento com <%= @appointment.worker_profile.user.full_name %>
      </div>

      <div class="small text-muted mt-1 d-flex align-items-center justify-content-center gap-2">
        <i class="fa-regular fa-clock"></i>
        <% appt_local = @appointment.starts_at.in_time_zone(@appointment.time_zone) %>
        <%= l(appt_local, format: :long) rescue appt_local %>
        <span class="badge bg-light text-dark border"><%= @appointment.time_zone %></span>
        <div
          data-controller="local-time"
          data-local-time-iso-value="<%= @appointment.starts_at.utc.iso8601 %>"
          data-local-time-label-value="<%= @appointment.time_zone %>">
        </div>
      </div>
    </div>

    <!-- right: propose button -->
    <div class="flex-shrink-0">
      <button type="button"
              class="btn bg-white border rounded-pill d-flex align-items-center gap-2 px-3 py-2 shadow-sm"
              data-bs-toggle="modal" data-bs-target="#proposeModal">
        <i class="fa-regular fa-calendar-plus"></i>
        <span>Propor novo horário</span>
      </button>
    </div>
  </div>

  <!-- Chat card START -->
  <div class="chat appt-chat-page">

    <!-- Messages (single loop) -->
    <div id="messages" class="messages">
      <% @appointment.messages.order(:created_at).each do |message| %>
        <%= render "messages/message", message: message, user: current_user %>
      <% end %>

      <%# ---------------- system bubbles rendered AFTER messages ---------------- %>

      <%# 1) worker-only accept/decline (pending) -------------------------------- %>
      <% if current_user.id == @appointment.worker_profile.user_id && @appointment.status.to_s == "pending" %>
        <div class="system-bubble text-center mb-3">
          <div class="mb-2 text-muted small">
            Este atendimento está <strong>pendente</strong>. Você deseja aceitar ou recusar?
          </div>
          <div class="d-flex gap-2 justify-content-center">
            <%= button_to "Aceitar",
                  accept_appointment_path(@appointment),
                  method: :patch,
                  class: "btn btn-primary rounded-pill px-4 py-2 fw-semibold shadow-sm",
                  form:  { class: "d-inline m-0 p-0 bg-transparent border-0" } %>

            <button type="button"
                    class="btn btn-danger rounded-pill px-4 py-2 fw-semibold shadow-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#declineModalShow">
              Recusar
            </button>
          </div>
        </div>
      <% end %>

      <%# 2) reschedule proposal bubble ----------------------------------------- %>
      <% if @appointment.proposed_starts_at.present? %>
        <% proposer_name =
             (@appointment.proposed_by_id == @appointment.user_id ?
               (@appointment.user.full_name.presence || @appointment.user.email) :
               (@appointment.worker_profile.user.full_name.presence || @appointment.worker_profile.user.email)) %>
        <div class="system-bubble text-center mb-3">
          <div class="mb-2">
            <strong>Proposta de novo horário:</strong>
            <%= l(@appointment.proposed_starts_at, format: :long) rescue @appointment.proposed_starts_at %>
            <small class="text-muted d-block">por <%= proposer_name %></small>
          </div>
          <div class="d-flex gap-2 justify-content-center">
            <% if @appointment.proposed_by_id != current_user.id %>
              <%= button_to "Aceitar", accept_proposed_appointment_path(@appointment),
                            method: :patch,
                            class: "btn btn-success rounded-pill px-4 py-2 fw-semibold shadow-sm",
                            form:  { class: "d-inline m-0 p-0 bg-transparent border-0" } %>
              <%= button_to "Recusar", decline_proposed_appointment_path(@appointment),
                            method: :patch,
                            class: "btn btn-outline-danger rounded-pill px-4 py-2 fw-semibold shadow-sm",
                            form:  { class: "d-inline m-0 p-0 bg-transparent border-0" } %>
            <% else %>
              <span class="badge bg-secondary-subtle text-secondary border">Aguardando resposta</span>
            <% end %>
          </div>
        </div>
      <% end %>

      <%# 3) review action bubble (client; past; accepted/pending) --------------- %>
      <% past       = @appointment.starts_at.present? && @appointment.starts_at < Time.current - 15.minutes %>
      <% valid_stat = %w[accepted pending].include?(@appointment.status.to_s) %>
      <% is_client  = current_user.id == @appointment.user_id %>
      <% can_review = is_client && past && valid_stat %>

      <% if can_review %>
        <% my_review = Review.find_by(appointment_id: @appointment.id, user_id: current_user.id) %>
        <div class="system-bubble text-center mb-3">
          <div class="actions">
            <% if my_review.present? %>
              <button type="button" class="btn btn-outline-secondary btn-sm"
                      data-bs-toggle="modal" data-bs-target="#editReviewModal">
                Editar avaliação
              </button>
              <%= button_to "Excluir",
                    review_path(my_review, return_to: appointment_path(@appointment)),
                    method: :delete,
                    form: { class: "d-inline", data: { turbo_confirm: "Remover sua avaliação?" } },
                    class: "btn btn-outline-danger btn-sm" %>
            <% else %>
              <button type="button" class="btn btn-success btn-sm d-flex align-items-center gap-2"
                      data-bs-toggle="modal" data-bs-target="#reviewModal">
                <i class="fa-solid fa-star"></i>
                Avaliar profissional
              </button>
            <% end %>
          </div>
        </div>
      <% end %>

      <div id="chat-tail" class="py-1"></div>
    </div>
    <!-- Messages END -->

    <!-- Composer -->
    <% other_user = current_user == @appointment.worker_profile.user ? @appointment.user : @appointment.worker_profile.user %>

    <% if @appointment.frozen_chat? %>
      <div class="system-bubble text-center">
        <strong>Chat encerrado.</strong>
        <div class="text-muted small">Uma das partes arquivou este atendimento; novas mensagens não são permitidas.</div>
      </div>
    <% else %>
      <%= simple_form_for [@appointment, @message],
        html: { class: "d-flex", data: { controller: "reset-form", action: "turbo:submit-end->reset-form#reset" } } do |f| %>
        <%= f.input :content,
            label: false,
            placeholder: "Mensagem para #{other_user.full_name}",
            wrapper_html: { class: "flex-grow-1" } %>
        <%= f.submit "Enviar", class: "btn btn-primary mb-3" %>
      <% end %>
    <% end %>

  </div>
  <!-- Chat card END -->

</div>

<%# Make sure my_review exists for the modals below %>
<% my_review ||= Review.find_by(appointment_id: @appointment.id, user_id: current_user.id) %>

<!-- Review modals -->
<%= render "review_modal", appointment: @appointment %>
<%= render "review_edit_modal", appointment: @appointment, my_review: my_review %>

<!-- Decline (show) -->
<div class="modal fade" id="declineModalShow" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Recusar agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <%= form_with url: decline_appointment_path(@appointment), method: :patch do %>
          <div class="mb-3">
            <label class="form-label">Motivo (opcional)</label>
            <textarea name="reason" class="form-control" rows="3"
                      placeholder="Ex.: Já tenho um compromisso nesse horário"></textarea>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-danger">Confirmar recusa</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<!-- Propose new time (show) -->
<div class="modal fade" id="proposeModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Propor novo horário</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>

      <div class="modal-body">
        <%= form_with url: propose_time_appointment_path(@appointment), method: :post, html: { class: "propose-time-form" } do %>
          <div class="mb-3">
            <label class="form-label">Novo dia e hora</label>
            <input
              type="text"
              name="proposed_starts_at"
              id="proposed_starts_at"
              class="form-control"
              placeholder="Selecione dia e hora"
              autocomplete="off"
              data-controller="flatpickr"
              data-flatpickr-enable-time-value="true"
              data-flatpickr-time-24hr-value="true"
              data-flatpickr-minute-increment-value="15"
              data-flatpickr-date-format-value="Y-m-d H:i"
              data-flatpickr-min-date-value="today"
            >
            <small class="text-muted">
              Será salvo no fuso do agendamento (<%= @appointment.time_zone %>).
            </small>
          </div>

          <div class="d-grid">
            <button type="submit" class="btn btn-primary">Enviar proposta</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  // keep auto-scroll
  function scrollChatTail() {
    const tail = document.getElementById('chat-tail');
    if (tail) tail.scrollIntoView({ behavior: 'auto' });
  }
  document.addEventListener('turbo:load', scrollChatTail);
  document.addEventListener('turbo:frame-load', scrollChatTail);
  document.addEventListener('turbo:before-stream-render', () => setTimeout(scrollChatTail, 30));
</script>
