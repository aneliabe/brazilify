<%= turbo_stream_from "appointment_#{@appointment.id}_messages" %>

<div class="container" style="max-width:1040px; margin:2rem auto;">
  <div class="chat appt-chat-page"><!-- 游댯 keep .chat so _chat.scss applies -->

    <!-- Header -->
    <div class="d-flex align-items-center justify-content-between gap-3 flex-wrap">
      <!-- esquerda: voltar -->
      <div class="d-flex align-items-center">
        <%= link_to my_appointments_path, class: "btn-line d-inline-flex align-items-center gap-2" do %>
          <i class="fa-solid fa-arrow-left"></i>
          Meus agendamentos
        <% end %>
      </div>

      <!-- centro: t칤tulo + data -->
      <div class="d-flex flex-column flex-grow-1 min-w-0" style="max-width: 720px;">
        <h1 class="h5 m-0 text-truncate">
          Seu agendamento com <%= @appointment.worker_profile.user.full_name %>
        </h1>
        <div class="small text-muted mt-1 d-flex align-items-center gap-2 flex-wrap">
          <i class="fa-regular fa-clock"></i>
          <% appt_local = @appointment.starts_at.in_time_zone(@appointment.time_zone) %>
          <span><%= l(appt_local, format: :long) rescue appt_local %></span>
          <span class="badge bg-light text-dark border"><%= @appointment.time_zone %></span>
          <div
            data-controller="local-time"
            data-local-time-iso-value="<%= @appointment.starts_at.utc.iso8601 %>"
            data-local-time-label-value="<%= @appointment.time_zone %>">
          </div>
        </div>
      </div>

      <!-- direita: a칞칫es -->
      <div class="d-flex align-items-center gap-2">
        <button type="button"
                class="btn-line"
                data-bs-toggle="modal" data-bs-target="#proposeModal">
          <i class="fa-regular fa-calendar-plus"></i>
          Propor novo hor치rio
        </button>

        <% if current_user.id == @appointment.worker_profile.user_id && @appointment.status.to_s == "pending" %>
          <%= button_to "Aceitar",
                accept_appointment_path(@appointment),
                method: :patch,
                class: "btn-line btn-accept" %>

          <button type="button"
                  class="btn-line btn-decline"
                  data-bs-toggle="modal"
                  data-bs-target="#declineModalShow">
            Recusar
          </button>
        <% end %>
      </div>
    </div>

    <!-- Messages -->
    <div id="messages" class="messages">
      <% @appointment.messages.order(:created_at).each do |message| %>
        <%= render "messages/message", message: message, user: current_user %>
      <% end %>

      <%# ---- proposal bubble (optional) ---- %>
      <% if @appointment.proposed_starts_at.present? %>
        <% proposer_name =
             (@appointment.proposed_by_id == @appointment.user_id ?
               (@appointment.user.full_name.presence || @appointment.user.email) :
               (@appointment.worker_profile.user.full_name.presence || @appointment.worker_profile.user.email)) %>
        <div class="system-bubble text-center">
          <div class="mb-2">
            <strong>Proposta de novo hor치rio:</strong>
            <%= l(@appointment.proposed_starts_at, format: :long) rescue @appointment.proposed_starts_at %>
            <small class="text-muted d-block">por <%= proposer_name %></small>
          </div>
          <div class="actions">
            <% if @appointment.proposed_by_id != current_user.id %>
              <%= button_to "Aceitar", accept_proposed_appointment_path(@appointment),
                            method: :patch, class: "btn btn-success btn-sm" %>
              <%= button_to "Recusar", decline_proposed_appointment_path(@appointment),
                            method: :patch, class: "btn btn-outline-danger btn-sm" %>
            <% else %>
              <span class="badge badge-pill bg-secondary-subtle text-secondary border border-secondary">
                Aguardando resposta
              </span>
            <% end %>
          </div>
        </div>
      <% end %>

      <%# ---- review actions bubble (como j치 existia) ---- %>
      <% my_review   = Review.where(worker_profile_id: @appointment.worker_profile_id, user_id: current_user.id).order(created_at: :desc).first %>
      <% past = @appointment.starts_at.present? && @appointment.starts_at < Time.current - 15.minutes %>
      <% valid_stat  = %w[accepted pending].include?(@appointment.status.to_s) %>
      <% is_client   = current_user.id == @appointment.user_id %>
      <% can_review  = is_client && past && valid_stat %>

      <% if can_review %>
        <div class="system-bubble text-center">
          <div class="actions">
            <% if my_review.present? %>
              <span class="badge badge-pill bg-success-subtle text-success border border-success">Avalia칞칚o feita</span>

              <button type="button" class="btn btn-outline-secondary btn-sm"
                      data-bs-toggle="modal" data-bs-target="#editReviewModal">
                Editar
              </button>

              <%= button_to "Excluir",
                    review_path(my_review, return_to: appointment_path(@appointment)),
                    method: :delete,
                    form: { class: "d-inline", data: { turbo_confirm: "Remover sua avalia칞칚o?" } },
                    class: "btn btn-outline-danger btn-sm" %>
            <% else %>
              <button type="button" class="btn btn-success btn-sm d-flex align-items-center gap-2"
                      data-bs-toggle="modal" data-bs-target="#reviewModal">
                <i class="fa-solid fa-star"></i>
                Avaliar profissional
              </button>
            <% end %>
          </div>
        </div>
      <% end %>

      <div id="chat-tail" class="py-1"></div>
    </div>

    <!-- Composer -->
    <% other_user = current_user == @appointment.worker_profile.user ? @appointment.user : @appointment.worker_profile.user %>

    <% if @appointment.frozen_chat? %>
      <div class="system-bubble text-center">
        <strong>Chat encerrado.</strong>
        <div class="text-muted small">Uma das partes arquivou este atendimento; novas mensagens n칚o s칚o permitidas.</div>
      </div>
    <% else %>
      <%= simple_form_for [@appointment, @message],
        html: { class: "d-flex", data: { controller: "reset-form", action: "turbo:submit-end->reset-form#reset" } } do |f| %>
        <%= f.input :content,
            label: false,
            placeholder: "Mensagem para #{other_user.full_name}",
            wrapper_html: { class: "flex-grow-1" } %>
        <%= f.submit "Enviar", class: "btn btn-primary mb-3" %>
      <% end %>
    <% end %>

  </div>
</div>

<!-- Review modals (j치 existentes) -->
<%= render "review_modal", appointment: @appointment %>
<%= render "review_edit_modal", appointment: @appointment, my_review: my_review %>

<!-- Decline (show) -->
<div class="modal fade" id="declineModalShow" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Recusar agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <%= form_with url: decline_appointment_path(@appointment), method: :patch do %>
          <div class="mb-3">
            <label class="form-label">Motivo (opcional)</label>
            <textarea name="reason" class="form-control" rows="3"
                      placeholder="Ex.: J치 tenho um compromisso nesse hor치rio"></textarea>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-danger">Confirmar recusa</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
  // keep auto-scroll
  function scrollChatTail() {
    const tail = document.getElementById('chat-tail');
    tail && tail.scrollIntoView({ behavior: 'auto' });
  }
  document.addEventListener('turbo:load', scrollChatTail);
  document.addEventListener('turbo:frame-load', scrollChatTail);
  document.addEventListener('turbo:before-stream-render', () => setTimeout(scrollChatTail, 30));
</script>
