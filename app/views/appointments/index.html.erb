<div class="appt-page">
  <div class="appt-wrap">
    <div class="appt-title">Meus agendamentos</div>

    <%# ------- Filters ------- %>
    <% active_as     = params[:as].to_s %>
    <% active_status = params[:status].to_s %>

    <!-- Role filter -->
    <div class="seg mb-2">
      <%= link_to "Todos (cliente + profissional)",
          my_appointments_path(status: active_status.presence),
          class: (active_as.blank? ? "active" : "") %>

      <%= link_to "Como cliente",
          my_appointments_path(as: "client", status: active_status.presence),
          class: (active_as == "client" ? "active" : "") %>

      <%= link_to "Como profissional",
          my_appointments_path(as: "worker", status: active_status.presence),
          class: (active_as == "worker" ? "active" : "") %>
    </div>

    <!-- Status filter -->
    <div class="seg mb-4">
      <%= link_to "Todos", my_appointments_path(as: active_as.presence),
          class: (active_status.blank? ? "active" : "") %>

      <%= link_to "Pendentes (#{@counts_by_status['pending'] || 0})",
          my_appointments_path(as: active_as.presence, status: "pending"),
          class: (active_status == "pending" ? "active" : "") %>

      <%= link_to "Aceitos (#{@counts_by_status['accepted'] || 0})",
          my_appointments_path(as: active_as.presence, status: "accepted"),
          class: (active_status == "accepted" ? "active" : "") %>

      <%= link_to "Recusados (#{@counts_by_status['declined'] || 0})",
          my_appointments_path(as: active_as.presence, status: "declined"),
          class: (active_status == "declined" ? "active" : "") %>
    </div>

    <% if @appointments.blank? %>
      <div class="appt-card" style="justify-content:center; text-align:center;">
        Nenhum agendamento.
      </div>
    <% else %>
      <div class="appt-list">
        <% @appointments.each do |a| %>
          <%# ---------- conflict check (worker, accepted only) ---------- %>
          <% conflict = false
             if current_user.respond_to?(:worker?) && current_user.worker? && a.status.to_s == "accepted"
               a_end = a.ends_at || (a.starts_at && a.starts_at + 1.hour)
               @appointments.each do |b|
                 next if b.id == a.id
                 next unless b.status.to_s == "accepted"
                 next unless b.worker_profile.user_id == current_user.id
                 b_end = b.ends_at || (b.starts_at && b.starts_at + 1.hour)
                 if a.starts_at && b.starts_at && (a.starts_at < b_end) && (b.starts_at < a_end)
                   conflict = true; break
                 end
               end
             end
          %>

          <% status = a.status.to_s %>
          <% is_participant = [a.user_id, a.worker_profile.user_id].include?(current_user.id) %>
          <% declined_like = %w[declined canceled cancelled].include?(status) %>
          <% status_icon = { "pending" => "fa-regular fa-clock",
                             "accepted" => "fa-solid fa-check",
                             "declined" => "fa-solid fa-xmark" }[status] || "fa-regular fa-calendar" %>

          <%# unread detection -> ping chat button %>
          <% last_read =
               if current_user.id == a.user_id
                 a.client_last_read_at
               else
                 a.worker_last_read_at
               end %>
          <% has_unread = a.messages.where("created_at > ? AND user_id != ?",
                                           (last_read || Time.at(0)), current_user.id).exists? %>

          <% other = (a.user_id == current_user.id) ? a.worker_profile.user : a.user %>
          <% avatar_url = other.respond_to?(:avatar) && other.avatar.present? ? other.avatar : "https://placehold.co/80x80" %>

          <div class="appt-card <%= 'conflict' if conflict %>">
            <!-- left -->
            <div class="who">
              <img class="avatar" src="<%= avatar_url %>" alt="">
              <div class="truncate">
                <div class="name">
                  <%= other.full_name.presence || other.email %>
                </div>
                <div class="meta">
                  <i class="fa-regular fa-calendar"></i>
                  <% local = a.starts_at&.in_time_zone(a.time_zone) %>
                  <%= local.present? ? (l(local, format: :short) rescue local) : "sem data" %>
                  <% if local.present? %>
                    <span class="badge bg-light text-dark border ms-1"><%= a.time_zone %></span>
                  <% end %>
                  <% if a.starts_at.present? %>
                    <div
                      data-controller="local-time"
                      data-local-time-iso-value="<%= a.starts_at.utc.iso8601 %>"
                      data-local-time-label-value="<%= a.time_zone %>">
                    </div>
                  <% end %>

                </div>
                <div class="chips">
                  <span class="chip chip-status <%= status %>">
                    <i class="<%= status_icon %>"></i> <%= status.upcase %>
                  </span>

                  <% if a.proposed_starts_at.present? %>
                    <span class="chip chip-proposed">
                      ⏱ Proposta: <%= l(a.proposed_starts_at, format: :short) rescue a.proposed_starts_at %>
                    </span>
                  <% end %>

                  <% if conflict %>
                    <span class="chip chip-conflict">⚠ CONFLITO</span>
                  <% end %>
                </div>
              </div>
            </div>

            <!-- right actions -->
            <div class="actions">
              <% if a.worker_profile.user_id == current_user.id && status == "pending" %>
                <%= button_to "Aceitar", accept_appointment_path(a),
                      method: :patch, class: "btn-line btn-accept" %>

                <button type="button"
                        class="btn-line btn-decline"
                        data-bs-toggle="modal"
                        data-bs-target="#declineModal"
                        data-appointment-id="<%= a.id %>">
                  Recusar
                </button>
              <% end %>

              <% past = a.starts_at.present? && a.starts_at < Time.zone.now %>
              <% can_archive = a.can_archive?(current_user) %>

              <%= link_to (has_unread ? "Abrir chat • Novas" : "Abrir chat"),
                          appointment_path(a),
                          class: "btn-line btn-chat #{has_unread ? 'ping' : ''}" %>

              <% can_delete_now = is_participant && (can_archive || declined_like) %>
              <% if can_delete_now %>
                <%= button_to "Excluir",
                      appointment_path(a),
                      method: :delete,
                      form: { data: { turbo_confirm: "Excluir este agendamento da sua lista? O chat ficará somente leitura para ambos." } },
                      class: "btn-line btn-decline" %>
              <% end %>
            </div>
          </div>
        <% end %>
      </div>
    <% end %>
  </div>
</div>

<!-- Decline with reason modal (shared) -->
<div class="modal fade" id="declineModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Recusar agendamento</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <%= form_with url: decline_appointment_path(0), method: :patch, id: "decline-form", data: { base_action: decline_appointment_path(0) } do %>
          <div class="mb-3">
            <label class="form-label">Motivo (opcional)</label>
            <textarea name="reason" class="form-control" rows="3" placeholder="Ex.: Já tenho um compromisso nesse horário"></textarea>
          </div>
          <div class="d-grid">
            <button type="submit" class="btn btn-danger">Confirmar recusa</button>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('show.bs.modal', function (event) {
  const modal = event.target;
  if (modal.id !== 'declineModal') return;
  const button = event.relatedTarget;
  const apptId = button?.getAttribute('data-appointment-id');
  const form = document.getElementById('decline-form');
  if (apptId && form) {
    const base = form.dataset.baseAction; // e.g., /appointments/0/decline
    form.action = base.replace('/0/', `/${apptId}/`);
  }
});
</script>
