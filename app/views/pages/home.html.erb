<div class="home-compact">

  <!-- Hero ribbon + search -->
  <%= render "shared/search_bar" , city: params[:city] %>

    <div class="container" style="max-width:1100px;">

      <!-- Serviços Populares (keeps your sizing, just polished) -->
      <section class="glass-card p-3 p-md-4 mb-4">
        <h2 class="section-title">Serviços Populares</h2>

        <div class="svc-grid chips">
          <% @popular_services.each do |svc| %>
            <%= link_to svc.name,
              search_path(
                city: current_user&.city || params[:city] || "cache",
                category_id: svc.category_id,
                service_id: svc.id
              ),
              class: "chip svc-card text-decoration-none" %>
            <% end %>
        </div>

              <!--<div class="text-end mt-3">
        <%= link_to "Ver todos os serviços", categories_path, class: "btn btn-light" %> -->

      </section>

      <!-- Destaques (logged in) OR your explainer (guest) -->
      <% if user_signed_in? %>
        <section class="mb-4">
          <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-2">
            <div style="display:flex; flex-direction:column; align-items:flex-start;">
              <h2 class="section-title" style="margin:0;">Prestadores de serviços em <%= @current_user.city %> - <%= link_to "Ver todos" , search_path, class: "btn btn-info btn-sm" %></h2>
              <p style="margin:6px 0 0 0; font-size:0.9rem; color:#6c757d;"><i>(cidade cadastrada)</i></p>

          <% if @top_workers.blank? %>
            <div class="glass-card p-4 text-center text-muted">Sem prestadores ainda.</div>
            <% else %>
              <div class="row g-3 top-workers">
                <% @top_workers.each do |w| %>
                  <div class="col-12 col-md-6 col-lg-4">
                    <div class="glass-card p-3 h-100 hover-lift d-flex flex-column">
                      <div class="d-flex gap-3 align-items-center">
                       <!-- <% if w.user&.photo&.attached? %>
                          <%= cl_image_tag w.user.photo.key, width: 72, height: 72, crop: :fill, gravity: :face,
                            class: "rounded-circle" , alt: (w.user.full_name || "Avatar" ),
                            style: "object-fit:cover;border:1px solid var(--stroke);" %>
                            <% else %>
                              <img src="https://placehold.co/72x72" alt="Avatar" class="rounded-circle"
                                style="width:72px;height:72px;object-fit:cover;border:1px solid var(--stroke);">
                              <% end %> -->
                              <%= render "shared/avatar", user: w.user, size: 72 %>

                                <div class="flex-grow-1 min-w-0">
                                  <!-- name -->
                                  <h3 class="h6 m-0 text-truncate">
                                    <%= w.user.full_name %>
                                  </h3>

                                  <!-- stars + rating + reviews -->
                                  <div class="d-flex align-items-center gap-2 mt-1 flex-wrap">
                                    <span class="stars text-warning">
                                      <% avg=w.average_rating.to_f %>
                                        <% 5.times do |i| %>
                                          <i class="fa-<%= i < avg.round ? 'solid' : 'regular' %> fa-star"></i>
                                          <% end %>
                                    </span>
                                    <span class="rating-pill">
                                      <%= number_with_precision(avg, precision: 1) %>
                                    </span>
                                    <small class="text-muted">
                                      <%= w.reviews.count %> avaliações
                                    </small>
                                  </div>

                                  <!-- location -->
                                  <small class="text-muted d-inline-flex align-items-center gap-1 mt-1">
                                    <i class="fa-solid fa-location-dot"></i>
                                    <%= [w.user.city, w.user.country].compact.join(", ") %>
                      </small>
                    </div>
                  </div>

                  <% if w.services.any? %>
                    <!-- 2-column fixed grid so chips align across cards -->
                    <div class=" chips-grid mt-2">
                                      <% w.services.limit(3).each_with_index do |svc, i| %>
                                        <span class="chip tone-<%= (i % 6) + 1 %> text-truncate">
                                          <i class="fa-solid fa-briefcase"></i>
                                          <%= svc.name %>
                                        </span>
                                        <% end %>
                                </div>
                                <% end %>

                                  <div class="mt-2 d-flex justify-content-end">
                                    <%= link_to "Ver perfil" , worker_path(w), class: "btn-line btn-chat" %>
                                  </div>
                      </div>
                    </div>
                    <% end %>
                  </div>
                  <% end %>
        </section>
        <% else %>
          <section class="mb-4">
            <%= render "shared/why_us_card" %>
          </section>
          <% end %>
    </div>
</div>
